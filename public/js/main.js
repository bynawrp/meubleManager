function addMateriau(){const container=document.getElementById('materiauxContainer');if(!container)return;const materiauxOptions=JSON.parse(container.getAttribute('data-materiaux-options')||'[]');const optionsHTML=materiauxOptions.map(m=>`<option value="${m.id}">${m.nom}(${m.type})</option>`).join('');const newRow=document.createElement('div');newRow.className='col-12';newRow.innerHTML=`<div class="card"><div class="card-body"><div class="row"><div class="col-md-6"><select class="form-select materiau-select" name="materiaux[materiau][]" required><option value="">Sélectionner un matériau</option>${optionsHTML}</select></div><div class="col-md-4"><input class="form-control" type="number" name="materiaux[quantite][]" placeholder="Quantité" value="1" min="1" required></div><div class="col-md-2"><button class="btn btn-secondary btn-border-theme btn-remove-materiau" type="button"><i data-feather="trash" class="feather-icon-md"></i></button></div></div></div></div>`;container.appendChild(newRow);if(typeof feather!=='undefined'){feather.replace();}const removeBtn=newRow.querySelector('.btn-remove-materiau');if(removeBtn){removeBtn.addEventListener('click',function(){removeMateriau(this);});}}function removeMateriau(button){const container=document.getElementById('materiauxContainer');if(!container)return;const rows=container.querySelectorAll('.col-12');if(rows.length>1){button.closest('.col-12').remove();}else{alert('Au moins un matériau est requis. Vous ne pouvez pas supprimer le dernier matériau.');}}document.addEventListener('DOMContentLoaded',function(){if(typeof feather!=='undefined'){feather.replace();}const sidebarToggle=document.getElementById('sidebarToggleTop');if(sidebarToggle){sidebarToggle.addEventListener('click',function(e){e.preventDefault();document.getElementById('accordionSidebar').classList.toggle('show');});}document.addEventListener('click',function(event){const sidebar=document.getElementById('accordionSidebar');const sidebarToggle=document.getElementById('sidebarToggleTop');const isClickInsideSidebar=sidebar&&sidebar.contains(event.target);const isClickOnToggle=sidebarToggle&&sidebarToggle.contains(event.target);if(window.innerWidth<992&&sidebar&&sidebar.classList.contains('show')&&!isClickInsideSidebar&&!isClickOnToggle){sidebar.classList.remove('show');}});const scrollToTopBtn=document.querySelector('.scroll-to-top');if(scrollToTopBtn){window.addEventListener('scroll',function(){scrollToTopBtn.style.display=window.pageYOffset>100?'flex':'none';});scrollToTopBtn.addEventListener('click',function(e){e.preventDefault();window.scrollTo({top:0,behavior:'smooth'});});}const chartMateriauxEl=document.getElementById('chartMateriaux');const chartFournisseursEl=document.getElementById('chartFournisseurs');const chartCategoriesEl=document.getElementById('chartCategories');if(chartMateriauxEl||chartFournisseursEl||chartCategoriesEl){const chartMateriauxData=chartMateriauxEl?JSON.parse(chartMateriauxEl.getAttribute('data-chart-materiaux')||'[]'):[];const chartFournisseursData=chartFournisseursEl?JSON.parse(chartFournisseursEl.getAttribute('data-chart-fournisseurs')||'[]'):[];const chartCategoriesData=chartCategoriesEl?JSON.parse(chartCategoriesEl.getAttribute('data-chart-categories')||'[]'):[];const getFournisseurColor=(nom)=>{const colors=['#FF8C42','#E74C3C','#2ECC71','#3498DB','#F39C12','#E67E22','#1ABC9C','#E91E63','#795548','#D35400'];return colors[Math.abs(nom.split('').reduce((a,b)=>a+b.charCodeAt(0),0))%colors.length];};const categorieColors={'Armoire':'#FF8C42','Etagère':'#2ECC71','Sans catégorie':'#6C7D9F'};if(chartMateriauxData.length>0&&chartMateriauxEl&&typeof Chart!=='undefined'){const ctxMateriaux=chartMateriauxEl;const labelsMateriaux=chartMateriauxData.map(m=>m.nom);const dataMateriaux=chartMateriauxData.map(m=>m.quantite);const getMaterialColor=(nom)=>{const nomLower=nom.toLowerCase();if(nomLower.includes('frêne')||nomLower.includes('frene')){return '#FF8C42';}else if(nomLower.includes('plastique')||nomLower.includes('plastic')){return '#3498DB';}else if(nomLower.includes('acier')||nomLower.includes('steel')){return '#2ECC71';}else if(nomLower.includes('noyer')||nomLower.includes('walnut')){return '#E74C3C';}else if(nomLower.includes('chêne')||nomLower.includes('chene')||nomLower.includes('oak')){return '#9B59B6';}else if(nomLower.includes('aluminium')||nomLower.includes('aluminum')){return '#6C7D9F';}else{const hash=Math.abs(nom.split('').reduce((a,b)=>a+b.charCodeAt(0),0));const colors=['#E67E22','#1ABC9C','#C0392B','#8E44AD','#27AE60','#2980B9','#795548','#16A085','#D35400','#34495E','#E91E63','#95A5A6','#D68910','#FF1744','#F39C12'];return colors[hash%colors.length];}};const backgroundColorsMateriaux=chartMateriauxData.map((m)=>{return getMaterialColor(m.nom);});new Chart(ctxMateriaux,{type:'pie',data:{labels:labelsMateriaux,datasets:[{data:dataMateriaux,backgroundColor:backgroundColorsMateriaux,borderColor:'#fff',borderWidth:2}]},options:{responsive:true,maintainAspectRatio:true,plugins:{legend:{position:'bottom',labels:{padding:15,font:{size:12}}},tooltip:{callbacks:{label:function(context){const label=context.label||'';const value=context.parsed||0;const total=context.dataset.data.reduce((a,b)=>a+b,0);const percentage=((value/total)*100).toFixed(1);return label+':'+value+' unités('+percentage+'%)';}}}}}});}if(chartFournisseursData.length>0&&chartFournisseursEl&&typeof Chart!=='undefined'){const ctxFournisseurs=chartFournisseursEl;const labelsFournisseurs=chartFournisseursData.map(f=>f.nom);const dataFournisseurs=chartFournisseursData.map(f=>f.quantite);const backgroundColorsFournisseurs=chartFournisseursData.map((f)=>{return getFournisseurColor(f.nom);});new Chart(ctxFournisseurs,{type:'pie',data:{labels:labelsFournisseurs,datasets:[{data:dataFournisseurs,backgroundColor:backgroundColorsFournisseurs,borderColor:'#fff',borderWidth:2}]},options:{responsive:true,maintainAspectRatio:true,plugins:{legend:{position:'bottom',labels:{padding:15,font:{size:12}}},tooltip:{callbacks:{label:function(context){const label=context.label||'';const value=context.parsed||0;const total=context.dataset.data.reduce((a,b)=>a+b,0);const percentage=((value/total)*100).toFixed(1);return label+':'+value+' unités('+percentage+'%)';}}}}}});}if(chartCategoriesData.length>0&&chartCategoriesEl&&typeof Chart!=='undefined'){const ctxCategories=chartCategoriesEl;const labelsCategories=chartCategoriesData.map(c=>c.nom);const dataCategories=chartCategoriesData.map(c=>c.realisations);const backgroundColorsCategories=chartCategoriesData.map(c=>{return categorieColors[c.nom]||categorieColors['Sans catégorie'];});new Chart(ctxCategories,{type:'bar',data:{labels:labelsCategories,datasets:[{label:'Nombre de meubles',data:dataCategories,backgroundColor:backgroundColorsCategories,borderColor:backgroundColorsCategories.map(c=>c),borderWidth:2}]},options:{responsive:true,maintainAspectRatio:false,plugins:{legend:{display:false},tooltip:{callbacks:{label:function(context){return context.parsed.y+' meuble'+(context.parsed.y>1?'s':'');}}}},scales:{y:{beginAtZero:true,ticks:{stepSize:1}}}}});}}const addMateriauBtn=document.querySelector('.btn-add-materiau');if(addMateriauBtn){addMateriauBtn.addEventListener('click',addMateriau);}const removeMateriauButtons=document.querySelectorAll('.btn-remove-materiau');removeMateriauButtons.forEach(btn=>{btn.addEventListener('click',function(){removeMateriau(this);});});const meublesForm=document.querySelector('form[action="/meubles"]');if(meublesForm){meublesForm.addEventListener('submit',function(e){const materiauxSelects=document.querySelectorAll('.materiau-select');const selectedMateriaux=Array.from(materiauxSelects).filter(select=>select.value!=='');if(selectedMateriaux.length===0){e.preventDefault();alert('Veuillez sélectionner au moins un matériau.');return false;}const realisations=document.getElementById('realisations');if(realisations&&(!realisations.value||parseInt(realisations.value)<1)){e.preventDefault();alert('Le nombre de réalisations doit être au moins égal à 1.');return false;}});}const filterForm=document.getElementById('filterForm');const searchInput=document.getElementById('searchInput');const categorieSelect=document.getElementById('categorieSelect');const tagInput=document.getElementById('tagInput');if(filterForm&&searchInput&&categorieSelect&&tagInput){let searchTimeout;let tagTimeout;function submitFilter(){filterForm.submit();}searchInput.addEventListener('input',function(){clearTimeout(searchTimeout);searchTimeout=setTimeout(submitFilter,500);});tagInput.addEventListener('input',function(){clearTimeout(tagTimeout);tagTimeout=setTimeout(submitFilter,500);});categorieSelect.addEventListener('change',function(){submitFilter();});}});
